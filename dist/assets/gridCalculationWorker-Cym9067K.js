(function(){"use strict";function g(y,v,M){const D=[],C=[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]];for(const[b,l]of C){const m=v+b,d=M+l;m>=0&&m<y.length&&d>=0&&d<y[0].length&&D.push({row:m,col:d})}return D}function R(y,v,M,D,C=[],b=[]){var K;const l=y.map(t=>[...t]),m=y.length,d=((K=y[0])==null?void 0:K.length)||0;let F=[];b.length===0?F=Array(m).fill(null).map(()=>Array(d).fill(-1)):F=b.map(t=>[...t]);const S=[],x=[],u=[],T=[],A=[];for(const t of C)if(l[t.from.row][t.from.col]===t.owner){const o=v[t.owner],r=l[t.to.row][t.to.col],j=r!==null?v[r]:null;let a=0;if(o){const e=o.virus.mobility/16,c=o.virus.infectivity/16,i=o.virus.aggression/16;if(a=(e+c+i)/3,j){const f=j.virus.resistance/16,p=j.virus.defense/16;a*=1-(f+p)/2}}a=Math.max(0,a);const s={...t,progress:Math.min(1,t.progress+a*.1)};s.progress>=1?(l[s.to.row][s.to.col]=s.owner,F[s.to.row][s.to.col]=M,T.push({position:s.to,type:"capture",player:s.owner}),r!==null&&T.push({position:s.to,type:"attack",player:r})):A.push(s)}for(let t=0;t<m;t++)for(let n=0;n<d;n++){const o=l[t][n];if(o!==null){const r=v[o];r&&(r.virus.aggression>10&&u.push({position:{row:t,col:n},type:"aggression",player:o}),r.virus.defense>10&&u.push({position:{row:t,col:n},type:"defense",player:o}),r.virus.speed>10&&u.push({position:{row:t,col:n},type:"speed",player:o}),r.virus.stealth>10&&u.push({position:{row:t,col:n},type:"stealth",player:o}),r.virus.resistance>10&&u.push({position:{row:t,col:n},type:"resistance",player:o}),r.virus.virulence>10&&u.push({position:{row:t,col:n},type:"virulence",player:o}),r.virus.mutation>10&&u.push({position:{row:t,col:n},type:"mutation",player:o}),r.virus.adaptability>10&&u.push({position:{row:t,col:n},type:"adaptability",player:o}),r.virus.endurance>10&&u.push({position:{row:t,col:n},type:"endurance",player:o}),r.virus.mobility>10&&u.push({position:{row:t,col:n},type:"mobility",player:o}),r.virus.intelligence>10&&u.push({position:{row:t,col:n},type:"intelligence",player:o}),r.virus.resilience>10&&u.push({position:{row:t,col:n},type:"resilience",player:o}),r.virus.infectivity>10&&u.push({position:{row:t,col:n},type:"infectivity",player:o}),r.virus.lethality>10&&u.push({position:{row:t,col:n},type:"lethality",player:o}),r.virus.stability>10&&u.push({position:{row:t,col:n},type:"stability",player:o}))}}const k=[];for(let t=0;t<m;t++)for(let n=0;n<d;n++){const o=l[t][n];if(o!==null){const r=v[o];if(r){const j=r.virus.stability>10;if(r.virus.mutation>8&&M>(r.lastMutationTurn||0)+Math.floor(Math.random()*3)+3){v[o].lastMutationTurn=M;const a=[],s=g(y,t,n);for(const e of s)l[e.row][e.col]===null&&a.push(e);if(a.length>0&&Math.random()<.5){const e=a[Math.floor(Math.random()*a.length)];if(Math.random()<.5)l[e.row][e.col]===null&&(l[e.row][e.col]=o);else{const c=[];for(let i=Math.max(0,e.row-2);i<Math.min(m,e.row+3);i++)for(let f=Math.max(0,e.col-2);f<Math.min(d,e.col+3);f++)l[i][f]===o&&c.push({row:i,col:f});if(c.length>0){const i=c[Math.floor(Math.random()*c.length)];g(y,i.row,i.col).filter(w=>l[w.row][w.col]===null).length>=2&&(l[i.row][i.col]=null)}}}}if(j){const s=g(y,t,n).filter(e=>l[e.row][e.col]===null);if(s.length>0){const e=s[Math.floor(Math.random()*s.length)],c=r.virus.reproduction/16,i=r.virus.infectivity/16,f=(c+i)/2;Math.random()<f&&(k.push({from:{row:t,col:n},to:e,player:o}),x.push({from:{row:t,col:n},to:e,player:o}))}}else{if(r.virus.stealth>10&&Math.random()<.3){const a=[];for(let s=-3;s<=3;s++)for(let e=-3;e<=3;e++)if(Math.abs(s)+Math.abs(e)>=2&&Math.abs(s)+Math.abs(e)<=3){const c=t+s,i=n+e;if(c>=0&&c<m&&i>=0&&i<d&&l[c][i]===null){const f=[],p=Math.max(Math.abs(s),Math.abs(e));for(let h=1;h<=p;h++){const O=t+Math.round(s*h/p),E=n+Math.round(e*h/p);O>=0&&O<m&&E>=0&&E<d&&f.push({row:O,col:E})}f.some(h=>l[h.row][h.col]===o)&&a.push({row:c,col:i})}}if(a.length>0){const s=a[Math.floor(Math.random()*a.length)],e=r.virus.stealth/16,c=r.virus.infectivity/16,i=(e+c)/2;Math.random()<i&&(k.push({from:{row:t,col:n},to:s,player:o}),x.push({from:{row:t,col:n},to:s,player:o}))}}if(r.virus.mobility>10){if(!r.preferredDirection){const e=[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]];r.preferredDirection=e[Math.floor(Math.random()*e.length)]}const s=g(y,t,n).filter(e=>l[e.row][e.col]===null);if(s.length>0){const e=r.virus.reproduction/16,c=r.virus.mobility/16,i=r.virus.infectivity/16,f=(e+c+i)/3;if(Math.random()<f){let p;if(r.preferredDirection){const w=s.filter(h=>h.row===t+r.preferredDirection[0]&&h.col===n+r.preferredDirection[1]);w.length>0&&Math.random()<.7?p=w[Math.floor(Math.random()*w.length)]:p=s[Math.floor(Math.random()*s.length)]}else p=s[Math.floor(Math.random()*s.length)];k.push({from:{row:t,col:n},to:p,player:o}),x.push({from:{row:t,col:n},to:p,player:o})}}}else{const s=g(y,t,n).filter(e=>l[e.row][e.col]===null);if(s.length>0){const e=r.virus.reproduction/16,c=r.virus.mobility/16,i=r.virus.infectivity/16,f=(e+c+i)/3;if(Math.random()<f){const p=s[Math.floor(Math.random()*s.length)];k.push({from:{row:t,col:n},to:p,player:o}),x.push({from:{row:t,col:n},to:p,player:o})}}}if(r.virus.aggression>12&&Math.random()<.2){const s=g(y,t,n).filter(e=>l[e.row][e.col]===null);if(s.length>=2){const e={};for(const i of s){const f=i.row-t,p=i.col-n,w=`${f},${p}`;e[w]||(e[w]=[]),e[w].push(i)}const c=Object.keys(e);if(c.length>0){const i=c[Math.floor(Math.random()*c.length)],f=e[i],p=Math.min(3,f.length),w=f.slice(0,p);for(const h of w)l[h.row][h.col]===null&&Math.random()<.7&&(l[h.row][h.col]=o,F[h.row][h.col]=M,x.push({from:{row:t,col:n},to:h,player:o}))}}}}}}}for(const t of k)l[t.to.row][t.to.col]===null&&(l[t.to.row][t.to.col]=t.player,F[t.to.row][t.to.col]=M);const N=[];for(let t=0;t<m;t++)for(let n=0;n<d;n++){const o=l[t][n];if(o!==null&&v[o]){const a=g(y,t,n).filter(s=>{const e=l[s.row][s.col];return e!==null&&e!==o});if(a.length>0){const s=a[Math.floor(Math.random()*a.length)],e=l[s.row][s.col];N.push({from:{row:t,col:n},to:s,attacker:o,defender:e})}}}for(const t of N)if(!C.find(o=>o.from.row===t.from.row&&o.from.col===t.from.col&&o.to.row===t.to.row&&o.to.col===t.to.col&&o.owner===t.attacker)){const o={id:`tentacle-${Date.now()}-${Math.random()}`,from:t.from,to:t.to,owner:t.attacker,progress:.05,type:"invasion"};A.push(o)}const $=[0,0,0,0];for(let t=0;t<m;t++)for(let n=0;n<d;n++){const o=l[t][n];o!==null&&o>=0&&o<4&&$[o]++}return{type:"calculationComplete",newGrid:l,turn:M+1,territoryCounts:$,attackEvents:S,expansionEvents:x,parameterEvents:u,interactionEvents:T,tentacles:A,cellAge:F}}self.onmessage=function(y){const{type:v,grid:M,players:D,turn:C,settings:b,tentacles:l,cellAge:m}=y.data;if(v==="calculateNextState"){const d=R(M,D,C,b,l,m);self.postMessage(d)}}})();
